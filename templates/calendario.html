{% extends 'base.html' %}

{% block content %}
<div style="max-width: 1000px; margin: 0 auto; text-align: left;">
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>üìÖ Agenda Completa</h2>
        <a href="{% url 'dashboard' %}" style="color: var(--text-muted);">‚Üê Voltar ao Painel</a>
    </div>

    <div style="margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid var(--border);">
        
        {% if user.perfil.tipo == 'Mentor' or user.is_superuser %}
            <a href="{% url 'nova_reuniao' %}" class="btn">+ Marcar Reuni√£o</a>
        {% else %}
            <a href="#" onclick="avisoApenasMentores(event)" class="btn btn-bloqueado">+ Marcar Reuni√£o</a>
        {% endif %}

        <a href="{% url 'nova_tarefa' %}" class="btn">+ Agendar Tarefa</a>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
        
        <div>
            <h3 style="background: var(--primary); color: white; padding: 12px; border-radius: 5px; margin-top: 0; text-align: center;">
                Pr√≥ximas Reuni√µes
            </h3>
            {% for r in reunioes %}
                <div style="background: var(--card-bg); border: 1px solid var(--border); padding: 15px; margin-bottom: 10px; border-radius: 5px; border-left: 5px solid var(--accent); position: relative;">
                    
                    <strong style="color: white; font-size: 1.1em;">{{ r.data_inicio|date:"d/m/Y" }} √†s {{ r.data_inicio|date:"H:i" }}</strong>
                    <p style="margin: 5px 0; color: var(--text-main); font-weight: bold;">{{ r.titulo }}</p>
                    
                    <div style="font-size: 0.9em; margin-top: 8px; color: var(--text-muted); border-top: 1px solid #333; padding-top: 8px;">
                        <div>
                            Organizador: <span style="color: white;">{{ r.solicitante.username }}</span>
                        </div>
                        <div style="margin-top: 3px;">
                            Convidados: 
                            {% for c in r.convidados.all %}
                                <span style="color: var(--accent);">{{ c.username }}</span>{% if not forloop.last %}, {% endif %}
                            {% empty %}
                                Ningu√©m
                            {% endfor %}
                        </div>
                    </div>

                    {% if r.link_externo %}
                        <div style="margin-top: 10px;">
                            <a href="{{ r.link_externo }}" target="_blank" style="font-size: 0.9em; color: var(--accent); font-weight: bold; display: inline-block;">
                                üîó Acessar Sala Virtual ‚Üí
                            </a>
                        </div>
                    {% endif %}

                    {% if r.solicitante == request.user %}
                        <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; gap: 10px; justify-content: flex-end;">
                            <a href="{% url 'editar_reuniao' r.id %}" style="font-size: 0.85em; color: #3498db; text-decoration: none; border: 1px solid #3498db; padding: 2px 8px; border-radius: 4px;">‚úèÔ∏è Editar</a>
                            <a href="{% url 'excluir_reuniao' r.id %}" onclick="return confirm('Tem certeza que deseja cancelar esta reuni√£o?')" style="font-size: 0.85em; color: #e74c3c; text-decoration: none; border: 1px solid #e74c3c; padding: 2px 8px; border-radius: 4px;">üóëÔ∏è Excluir</a>
                        </div>
                    {% endif %}
                </div>
            {% empty %}
                <p style="color: var(--text-muted); text-align: center; padding: 20px; border: 1px dashed var(--border); border-radius: 5px;">Nenhuma reuni√£o futura agendada.</p>
            {% endfor %}
        </div>

        <div>
            <h3 style="background: var(--primary); color: white; padding: 12px; border-radius: 5px; margin-top: 0; text-align: center;">
                Tarefas Pendentes
            </h3>
            
            {% for t in tarefas %}
                <div style="background: var(--card-bg); border: 1px solid var(--border); padding: 15px; margin-bottom: 10px; border-radius: 5px; border-left: 5px solid var(--text-muted);">
                    <strong style="color: white; font-size: 1.1em;">{{ t.titulo }}</strong>
                    
                    {% if t.informacoes %}
                        <p style="margin: 5px 0; color: var(--text-muted); font-size: 0.9em; font-style: italic;">{{ t.informacoes }}</p>
                    {% endif %}
                    
                    <div style="margin-top: 10px; font-size: 0.85em; color: var(--text-muted);">
                        Prazo: <span style="color: #f1c40f; font-weight: bold;">{{ t.data_prazo|date:"d/m/Y" }}</span>
                    </div>

                    {% if t.criador == request.user %}
                        <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; gap: 10px; justify-content: flex-end;">
                            <a href="{% url 'editar_tarefa' t.id %}" style="font-size: 0.85em; color: #3498db; text-decoration: none; border: 1px solid #3498db; padding: 2px 8px; border-radius: 4px;">‚úèÔ∏è Editar</a>
                            <a href="{% url 'excluir_tarefa' t.id %}" onclick="return confirm('Tem certeza que deseja excluir esta tarefa?')" style="font-size: 0.85em; color: #e74c3c; text-decoration: none; border: 1px solid #e74c3c; padding: 2px 8px; border-radius: 4px;">üóëÔ∏è Excluir</a>
                        </div>
                    {% endif %}
                </div>
            {% empty %}
                <p style="color: var(--text-muted); text-align: center; padding: 20px; border: 1px dashed var(--border); border-radius: 5px;">Nenhuma tarefa pendente.</p>
            {% endfor %}

            {% if tarefas_antigas %}
                <div style="margin-top: 30px; text-align: center;">
                    <button onclick="toggleTarefasAntigas()" id="btnTarefasAntigas" style="background: transparent; border: 1px solid var(--text-muted); color: var(--text-muted); padding: 10px 20px; cursor: pointer; border-radius: 20px; transition: 0.3s;">
                        ‚¨áÔ∏è Ver Tarefas Antigas ({{ tarefas_antigas.count }})
                    </button>
                </div>

                <div id="listaTarefasAntigas" style="display: none; margin-top: 15px; opacity: 0; transition: opacity 0.5s;">
    {% for t in tarefas_antigas %}
        <div style="background: rgba(255,255,255,0.05); border: 1px solid #333; padding: 10px; margin-bottom: 8px; border-radius: 5px; opacity: 0.7;">
            
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <strong style="color: #aaa; text-decoration: line-through;">{{ t.titulo }}</strong>
                <span style="font-size: 0.8em; color: #e74c3c;">Venceu em: {{ t.data_prazo|date:"d/m/Y" }}</span>
            </div>

            {% if t.informacoes %}
                <p style="margin: 8px 0 5px 0; color: #888; font-size: 0.9em; font-style: italic; border-left: 2px solid #555; padding-left: 8px;">
                    {{ t.informacoes }}
                </p>
            {% endif %}

            {% if t.criador == request.user %}
            <div style="text-align: right; margin-top: 5px;">
                <a href="{% url 'excluir_tarefa' t.id %}" onclick="return confirm('Excluir hist√≥rico desta tarefa?')" style="font-size: 0.75em; color: #e74c3c; text-decoration: none;">üóëÔ∏è Limpar do Hist√≥rico</a>
            </div>
            {% endif %}

        </div>
    {% endfor %}
</div>
            {% endif %}

        </div>

    </div>
</div>

<div id="toast-aviso" class="toast-hidden">
    üö´ Apenas mentores podem criar reuni√µes.
</div>

<style>
    @media (max-width: 768px) {
        div[style*="display: grid"] {
            grid-template-columns: 1fr !important;
        }
    }
    
    a[href*="editar"]:hover { background: rgba(52, 152, 219, 0.1); }
    a[href*="excluir"]:hover { background: rgba(231, 76, 60, 0.1); }

    .btn-bloqueado { opacity: 0.5; cursor: not-allowed; background-color: #444; }

    .toast-hidden { visibility: hidden; min-width: 250px; background-color: #c0392b; color: #fff; text-align: center; border-radius: 5px; padding: 16px; position: fixed; z-index: 1000; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 17px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
    .toast-show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
    @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
    @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
</style>

<script>
    function avisoApenasMentores(e) {
        e.preventDefault();
        var x = document.getElementById("toast-aviso");
        x.className = "toast-show";
        setTimeout(function(){ x.className = x.className.replace("toast-show", "toast-hidden"); }, 3000);
    }

    function toggleTarefasAntigas() {
        var lista = document.getElementById("listaTarefasAntigas");
        var btn = document.getElementById("btnTarefasAntigas");
        
        if (lista.style.display === "none") {
            lista.style.display = "block";
            // Pequeno delay para a anima√ß√£o de opacidade funcionar
            setTimeout(function() { lista.style.opacity = "1"; }, 10);
            btn.innerHTML = "‚¨ÜÔ∏è Ocultar Tarefas Antigas";
        } else {
            lista.style.opacity = "0";
            // Espera a anima√ß√£o acabar para dar display none
            setTimeout(function() { lista.style.display = "none"; }, 500);
            btn.innerHTML = "‚¨áÔ∏è Ver Tarefas Antigas";
        }
    }
</script>
{% endblock %}
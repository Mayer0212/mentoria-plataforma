{% extends 'base.html' %}

{% block content %}
<style>
    /* 1. CLASSE BASE DO BALÃO */
    .balao-msg {
        max-width: 70%;
        padding: 12px 18px;
        border-radius: 15px;
        position: relative;
        word-wrap: break-word;
        margin-bottom: 10px; /* Espaço entre balões */
    }

    /* 2. QUANDO SOU EU (Vermelho/Direita) */
    .msg-enviada {
        align-self: flex-end;
        background-color: var(--primary);
        color: white;
        border-bottom-right-radius: 2px;
    }

    /* 3. QUANDO É O OUTRO (Cinza/Esquerda) */
    .msg-recebida {
        align-self: flex-start;
        background-color: #2c2c2c;
        color: #e0e0e0;
        border-bottom-left-radius: 2px;
        border: 1px solid #333;
    }
</style>

<div style="max-width: 800px; margin: 0 auto; text-align: left;">

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px;">
        <div style="display: flex; align-items: center; gap: 15px;">
            {% if outro_usuario.perfil.foto %}
                <img src="{{ outro_usuario.perfil.foto.url }}" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent);">
            {% else %}
                <div style="width: 50px; height: 50px; background: #333; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid var(--border);">
                    {{ outro_usuario.username|make_list|first|upper }}
                </div>
            {% endif %}
            
            <div>
                <a href="{% url 'perfil_publico' outro_usuario.username %}" style="text-decoration: none;">
                    <h2 style="margin: 0; font-size: 1.4em; color: white; cursor: pointer; transition: color 0.2s;">
                        {{ outro_usuario.username }}
                    </h2>
                </a>
                <style> h2:hover { color: var(--accent) !important; } </style>

                <small style="color: var(--text-muted);">
                    {{ outro_usuario.perfil.profissao|default:"Usuário" }}
                </small>
            </div>
        </div>
        <a href="{% url 'lista_usuarios' %}" class="btn" style="background: #333; font-size: 0.9em; border: 1px solid var(--border);">Voltar</a>
    </div>

    <div id="chat-box" style="
            background-color: #000; 
            height: 400px; 
            overflow-y: auto; 
            padding: 20px; 
            border-radius: 8px; 
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;">
        
        {% for msg in mensagens %}
            
            <div class="balao-msg {% if msg.remetente == user %}msg-enviada{% else %}msg-recebida{% endif %}">
                
                <p style="margin: 0; line-height: 1.4; color: inherit;">{{ msg.conteudo }}</p>
                
                <div style="display: flex; justify-content: flex-end; align-items: center; gap: 5px; margin-top: 5px;">
                    <span style="font-size: 0.7em; opacity: 0.7;">
                        {{ msg.data_envio|date:"H:i" }}
                    </span>
                    {% if msg.remetente == user %}
                        <span style="font-size: 0.7em; opacity: 0.8;">
                            {% if msg.lido %}✓✓{% else %}✓{% endif %}
                        </span>
                    {% endif %}
                </div>

            </div>

        {% empty %}
            <div style="text-align: center; color: var(--text-muted); margin-top: 50px;">
                <p>Nenhuma mensagem ainda.</p>
                <small>Diga "Olá" para começar!</small>
            </div>
        {% endfor %}
    </div>

    <form method="post" style="display: flex; gap: 10px;">
        {% csrf_token %}
        <input type="text" name="conteudo" placeholder="Digite sua mensagem..." required autofocus autocomplete="off"
               style="flex: 1; padding: 15px; border-radius: 30px; background: var(--card-bg); border: 1px solid var(--border); color: white;">
        <button type="submit" class="btn" style="border-radius: 50%; width: 50px; height: 50px; padding: 0; display: flex; align-items: center; justify-content: center; font-size: 1.2em;">➤</button>
    </form>

</div>

<script>
    window.onload = function() {
        var chatBox = document.getElementById("chat-box");
        if(chatBox) chatBox.scrollTop = chatBox.scrollHeight;
    }
</script>

<style>
    #chat-box::-webkit-scrollbar { width: 8px; }
    #chat-box::-webkit-scrollbar-track { background: #121212; }
    #chat-box::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
    #chat-box::-webkit-scrollbar-thumb:hover { background: var(--primary); }
</style>
{% endblock %}